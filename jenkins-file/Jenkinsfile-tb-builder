import groovy.time.DateFormatter

node {
  def remote = [:]
  remote.name = 'dev2'
  remote.host = '172.16.4.3'
  remote.user = 'root'
  remote.password = 'qw12'
  remote.allowAnyHosts = true

  def getCurrentTime() {
    // Get the current time in milliseconds.
    long timestamp = System.currentTimeMillis()

    // Create a DateFormatter object.
    DateFormatter formatter = new DateFormatter('yyyy-MM-dd_HH-mm-ss')

    // Format the current time.
    formatter.format(timestamp)
  }

  def DB_NAME = 'thingsboard'
  // backup name format = System name + database name + date + time + backup type
  def BACKUP_FILE_NAME = "${remote.name}-${DB_NAME}-${getCurrentTime()}-FULL.sql"
  def DB_BACK_UP_COMMAND = "pg_dump -U postgres -d ${DB_NAME} > ${BACKUP_FILE_NAME}"

  stage('Checking host ...') {
    sshCommand remote: remote, command: "docker --version" , failOnError: true
    sshCommand remote: remote, command: "psql --version" , failOnError: true
  }

  stage('Backuping DB ...') {
    sshCommand remote: remote, command: DB_BACK_UP_COMMAND, failOnError: true
    sshGet remote: remote, from: BACKUP_FILE_NAME, into: BACKUP_FILE_NAME, override: true, failOnError: true
  }

}